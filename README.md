# TenSIR

Parameter estimation on epidemic data under the [SIR model][sir] using a novel algorithm for differentiated
[uniformization][uniformization] of [Markov transition rate matrices][markov] in [tensor representation][tensor].

This repository contains the code for the manuscript
[Differentiated uniformization: A new method for inferring Markov chains on combinatorial state spaces including stochastic epidemic models][paper].

## Data

We used the data from the [Austrian BMSGPK][data-src] on the COVID-19 pandemic from March 2020 to August 2020. A CSV
file containing the data used by us can be found [here][csv] if the API is subject to change in the future.

### Susceptible and infected people to/with COVID-19 in Austria during the early months of the pandemic

![Timeline plot][timeline]

## Results

### Kernel density estimation plot of points generated by Hamilton Monte Carlo simulation

![HMC plot][hmc]

The **x** marks the least squares estimate after grid search using the default deterministic model (system of ODEs).

## Reproducing the results

### Prerequisites

- Python 3.9+ (tested with Python 3.9). For installation instructions please refer to [the documentation][python]. Also
  make sure that Python and Pip are [in your PATH][path] and reachable from a terminal/Powershell via `python3` and
  `pip3`.

### Setup

We advise you to use a [virtual environment][venv] for running the code. See setup and activation instructions
[here][venv-install]. After you activated it, run the following command to install the dependencies:

```bash
pip3 install -r requirements.txt
```

### Generating points

To exactly reproduce our results, one should use the [generate-points.py] script. For example, to generate 1000 points
using HMC sampling for month March (3) in run number 0 with 16 threads, do:

```bash
python3 source/generate-points.py --sampling hmc --points 1000 --month 3 --run 0 --threads 16
```

Use the `--help` option to show all possible/necessary parameters:

```bash
python3 source/generate-points.py --help
```

The random number generator is seeded uniquely for each run by `seed = month * 1000 + run`.

Technically any thread count can be set, but vanishing returns are expected for thread counts greater than 60.
The runs are independent and can be computed in parallel on e.g. different compute nodes.

#### Leveraging HPC clusters

Especially for months March, April and August the simulation can take quite some time. We suggest you use a compute
cluster if accessible. Please refer to your cluster's documentation or administration for setup instructions.

### Create plots

First, make sure that the venv is still activated.

Once you have the points in the `results` directory you can generate all plots by:

```bash
python3 source/plots.py all
```

The plots will be generated into the `plots` directory.

Again you can use `--help` to see all options, including generating specific plots:

```bash
python3 source/plots.py --help
```

## Technical notes for understanding/reviewing the code

In our framework we use the convention `Theta = (alpha, beta)` and `theta = (log(alpha), log(beta))` where `alpha`,
`beta` are the parameters of the SIR model.

For specific reference about a function/module please see the doc strings in the code itself. Furthermore, see the
repository's structure:

### Project structure

```
.
├── cache/                     Directory for temporary caching (e.g. the downloaded data or the states
│   │                          of the RNG when generating points)
│   └── data-austria.csv       Cached CSV file containing the raw data
├── logs/                      Target directory for logs which are output during generation of points
├── results/                   Target directory for simulation/plotting results
│   ├── hmc-points/            Target for generated points with the HMC sampler
│   ├── mh-points/             Target for generated points with the HM sampler
│   └── plots/                 Target for generated plots
├── source/                    Directory containing all source code
│   ├── tensir/                Module containing all the library functionality (not intended to be used via public CLI)
│   │   ├── optimize/          Module containing optimization routines (deterministic ODE solver, grid search,
│   │   │                      gradient ascent)
│   │   ├── sampling/          Module containing the implementation of samplers (MH and HMC)
│   │   └── uniformization/    Implementation of the derivative and forward evaluation via uniformization (research
│   │                          object of this paper)
│   ├── generate-points.py     Main script to generate, i.e. sample, points
│   └── plots.py               Main script to generate the plots
└── requirements.txt           Text file containing all dependencies (adhering to the Python convention)
```

[sir]: https://en.wikipedia.org/wiki/Compartmental_models_in_epidemiology#The_SIR_model

[uniformization]: https://en.wikipedia.org/wiki/Uniformization_(probability_theory)

[markov]: https://en.wikipedia.org/wiki/Transition_rate_matrix

[tensor]: https://en.wikipedia.org/wiki/Tensor_product#Tensor_product_of_linear_maps

[paper]: https://arxiv.org/abs/2112.10971

[data-src]: https://www.data.gv.at/katalog/dataset/ef8e980b-9644-45d8-b0e9-c6aaf0eff0c0

[csv]: cache/data-austria.csv

[hmc]: results/plots/png/density/density-hmc.png

[timeline]: results/plots/png/timeline.png

[venv]: https://docs.python.org/3/library/venv.html

[venv-install]: https://docs.python.org/3/library/venv.html#creating-virtual-environments

[generate-points.py]: source/generate-points.py

[python]: https://www.python.org/about/gettingstarted/

[path]: https://realpython.com/add-python-to-path/
